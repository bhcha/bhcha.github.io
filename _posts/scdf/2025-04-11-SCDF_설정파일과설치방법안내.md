---
layout: single
title: ğŸ”€ Onâ€‘Premises í™˜ê²½ì—ì„œì˜ SCDF 2.11.5 ì„¤ì • íŒŒì¼ê³¼ ì„¤ì¹˜ ë°©ë²• ì•ˆë‚´
categories: SCDF
tags: [SCDF, Onâ€‘Premises, Docker Compose]
toc: true
---

> íŒ€ ë¸”ë¡œê·¸ìš© ì›ê³   
 
> [ì´ì „ : ì„¤ì¹˜ ë° êµ¬ì„±ê°€ì´ë“œ](../ì„¤ì¹˜ë°êµ¬ì„±ê°€ì´ë“œ)

ì´ì „ ê¸€ì—ì„œëŠ” SCDF í™˜ê²½ ë° êµ¬ì„±ì— ëŒ€í•œ ë‚´ìš©ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ë²ˆê¸€ì—ì„  ì„¤ì •ëœ docker-composeíŒŒì¼ì„ ì‚´í´ë³´ë©° ì„¤ì¹˜ ë°©ë²•ê¹Œì§€ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤. ê° ì„¤ì •í•­ëª©ë³„ ìƒì„¸ ì„¤ì •ì€ ë³„ë„ í¬ìŠ¤íŒ…ì„ í†µí•´ ë‹¤ë¤„ë³´ê² ìŠµë‹ˆë‹¤.

---

## ğŸ›  ì„¤ì •íŒŒì¼

### ğŸ“„ docker-compose.yml
dataflow serverì™€ skipper serverë¥¼ ì„¤ì¹˜í•˜ëŠ” ë©”ì¸ì´ ë˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤. [ê³µì‹ì„¤ì •](https://github.com/spring-cloud/spring-cloud-dataflow/blob/main/src/docker-compose/docker-compose.yml)ì— í•„ìš”í•œ ì¶”ê°€ ì„¤ì •í•­ëª©ì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.

- ì¶”ê°€ ì„¤ì •í•­ëª©
   - Context Path
   - Nexus Repository
   - ì¸ì¦(Keycloak)
```yaml
services:
  dataflow-server:
    user: root
    image: springcloud/spring-cloud-dataflow-server:2.11.5-jdk17
    container_name: dataflow-server
    ports:
      - "9393:9393"
    environment:
      # ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ ì„¤ì •
      - SERVER_SERVLET_CONTEXT_PATH=/dataflow

      # íƒ€ì„ì¡´ ì„¤ì •
      - TZ=Asia/Seoul
      - LANG=en_US.utf8
      - LC_ALL=en_US.utf8
      - JAVA_OPTS=-Duser.timezone=Asia/Seoul -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8
      - SPRING_CLOUD_KUBERNETES_ENABLED=false
      - SPRING_CLOUD_DATAFLOW_APPLICATIONPROPERTIES_TASK_SPRING_CLOUD_TASK_CLOSECONTEXTENABLED=true
      - SPRING_CLOUD_SKIPPER_CLIENT_SERVER_URI=${SKIPPER_URI:-http://skipper-server:7577}/api
      - SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRY_CONFIGURATIONS_DEFAULT_USER=${METADATA_DEFAULT_DOCKERHUB_USER}
      - SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRY_CONFIGURATIONS_DEFAULT_SECRET=${METADATA_DEFAULT_DOCKERHUB_PASSWORD}
      - SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRYCONFIGURATIONS_DEFAULT_USER=${METADATA_DEFAULT_DOCKERHUB_USER}
      - SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRYCONFIGURATIONS_DEFAULT_SECRET=${METADATA_DEFAULT_DOCKERHUB_PASSWORD}
      
      # Nexus Repository ì—°ê²°
      - MAVEN_REMOTEREPOSITORIES_REPO1_URL= #http://ë„¥ì„œìŠ¤/repository/dataflow-proxy/
      - MAVEN_REMOTEREPOSITORIES_REPO1_AUTH_USERNAME= #ë„¥ì„œìŠ¤ê³„ì •
      - MAVEN_REMOTEREPOSITORIES_REPO1_AUTH_PASSWORD= #ë„¥ì„œìŠ¤ë¹„ë°€ë²ˆí˜¸

      # ì¸ì¦(Keycloak)
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_CLIENTID= #í‚¤í´ë½ í´ë¼ì´ì–¸íŠ¸
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_CLIENTSECRET= #í‚¤í´ë½ í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_REDIRECTURI= #https://í‚¤í´ë½/dataflow/login/oauth2/code/keycloak
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_AUTHORIZATIONGRANTTYPE=authorization_code
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KEYCLOAK_SCOPE=openid,profile,email,dataflow.view,dataflow.deploy,dataflow.destroy,dataflow.manage,dataflow.modify,dataflow.schedule,dataflow.create
      - SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_JWKSETURI= #https://í‚¤í´ë½/keycloak/realms/í‚¤í´ë½ë ë¦„/protocol/openid-connect/certs
      - SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_TOKENURI= #https://í‚¤í´ë½/keycloak/realms/í‚¤í´ë½ë ë¦„/protocol/openid-connect/token
      - SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_USERINFOURI= #https://í‚¤í´ë½/keycloak/realms/í‚¤í´ë½ë ë¦„/protocol/openid-connect/userinfo
      - SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_USERNAMEATTRIBUTE=email
      - SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_AUTHORIZATIONURI= #https://í‚¤í´ë½/keycloak/realms/í‚¤í´ë½ë ë¦„/protocol/openid-connect/auth

      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUETOKEN_INTROSPECTIONURI= #https://í‚¤í´ë½/keycloak/realms/í‚¤í´ë½ë ë¦„/protocol/openid-connect/token/introspect
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUETOKEN_CLIENTID=dataflow
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_OPAQUETOKEN_CLIENTSECRET= #í‚¤í´ë½ í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿
    depends_on:
      - skipper-server
    restart: always
    volumes:
      - ${HOST_MOUNT_PATH:-.}:${DOCKER_MOUNT_PATH:-/home/cnb/scdf}
      # ì¸ì¦(Keycloak) ê¶Œí•œ ì„¤ì •íŒŒì¼
      - ./application.yml:/workspace/config/application.yml
    command: ["java", "-Duser.timezone=Asia/Seoul", "-jar", "/app.jar"]


  # ë³´ì•ˆì ìš©í›„ ì‚¬ìš©ë¶ˆê°€
  app-import-stream:
    image: springcloud/baseimage:1.0.4
    container_name: dataflow-app-import-stream
    depends_on:
      - dataflow-server
  app-import-task:
    image: springcloud/baseimage:1.0.4
    container_name: dataflow-app-import-task
    depends_on:
      - dataflow-server
    command: >
      /bin/sh -c "
        ./wait-for-it.sh -t 360 dataflow-server:9393;
        wget -qO- '${DATAFLOW_URI:-http://dataflow-server:9393}/apps' --no-check-certificate --post-data='uri=${TASK_APPS_URI:-https://dataflow.spring.io/task-maven-3-0-x&force=true}';
        echo ${TASK_APPS_URI:-https://dataflow.spring.io/task-maven-3-0-x&force=true};
        echo 'Maven Task apps imported'"


  skipper-server:
    user: root
    image: springcloud/spring-cloud-skipper-server:2.11.5-jdk17
    container_name: skipper-server
    ports:
      - "7577:7577"
      - ${APPS_PORT_RANGE:-20000-20195:20000-20195}
    environment:
      - TZ=Asia/Seoul
      - LANG=en_US.utf8
      - LC_ALL=en_US.utf8
      - JDK_JAVA_OPTIONS=-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8
      - SERVER_PORT=7577
      - SPRING_CLOUD_KUBERNETES_ENABLED=false
      - SPRING_CLOUD_SKIPPER_SERVER_PLATFORM_LOCAL_ACCOUNTS_DEFAULT_PORTRANGE_LOW=20000
      - SPRING_CLOUD_SKIPPER_SERVER_PLATFORM_LOCAL_ACCOUNTS_DEFAULT_PORTRANGE_HIGH=20190
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD_SKIPPER_SERVER_DEPLOYER=ERROR
      -
      # Nexus Repository ì—°ê²°
      - MAVEN_REMOTEREPOSITORIES_REPO1_URL= #http://ë„¥ì„œìŠ¤/repository/dataflow-proxy/
      - MAVEN_REMOTEREPOSITORIES_REPO1_AUTH_USERNAME= #ë„¥ì„œìŠ¤ê³„ì •
      - MAVEN_REMOTEREPOSITORIES_REPO1_AUTH_PASSWORD= #ë„¥ì„œìŠ¤ë¹„ë°€ë²ˆí˜¸

    restart: always
    volumes:
      - ${HOST_MOUNT_PATH:-.}:${DOCKER_MOUNT_PATH:-/home/cnb/scdf}
      - /home/workday:/home/workday
      - /data/images:/data/images
    command: ["java", "-Duser.timezone=Asia/Seoul", "-jar", "/app.jar"]


```


### ğŸ“„ application.yml
docker-compose ì„¤ì •ì— í¬í•¨í•˜ë ¤ í–ˆìœ¼ë‚˜ ROLEì— ëŒ€í•œ ì†ì„±ì´ ì ìš©ë˜ì§€ ì•Šì•„ ë³„ë„ë¡œ ë¶„ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
```yaml
spring:
  cloud:
    dataflow:
      security:
        authorization:
          provider-role-mappings:
            keycloak:
              map-oauth-scopes: true
              role-mappings:
                ROLE_VIEW: dataflow.view
                ROLE_CREATE: dataflow.create
                ROLE_MANAGE: dataflow.manage
                ROLE_DEPLOY: dataflow.deploy
                ROLE_DESTROY: dataflow.destroy
                ROLE_MODIFY: dataflow.modify
                ROLE_SCHEDULE: dataflow.schedule
```

### ğŸ“„ [docker-compose-kafka.yml](https://github.com/spring-cloud/spring-cloud-dataflow/blob/main/src/docker-compose/docker-compose-kafka.yml)
message brokerë¥¼ kafakaë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤. ê³µì‹ì„¤ì •ì— ì„œë²„ ì •ë³´ë§Œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

### ğŸ“„ [docker-compose-prometheus.yml](https://github.com/spring-cloud/spring-cloud-dataflow/blob/main/src/docker-compose/docker-compose-prometheus.yml)
ëª¨ë‹ˆí„°ë§ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤. ê³µì‹ì„¤ì •ì— ì„œë²„ ì •ë³´ë§Œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.

### ğŸ“„ [docker-compose-mariadb.yml](https://github.com/spring-cloud/spring-cloud-dataflow/blob/main/src/docker-compose/docker-compose-mariadb.yml)
mariadb ì‚¬ìš©ì„ ìœ„í•œ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤. ê³µì‹ì„¤ì •ì— ì„œë²„ ì •ë³´ë§Œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.


## ğŸ’¾ ì„¤ì¹˜íŒŒì¼
### ğŸ–¥ï¸ [dc.sh](https://github.com/spring-cloud/spring-cloud-dataflow/blob/main/src/docker-compose/dc.sh)
ê³µì‹ë¬¸ì„œì—ëŠ” ì—†ìœ¼ë‚˜ ê³µì‹ gitì— ìˆëŠ” ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤. í•„ìˆ˜ëŠ” ì•„ë‹ˆë‚˜ í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì¹˜ í•©ë‹ˆë‹¤.


---

## ğŸ”§ ì„¤ì¹˜ë°©ë²•
- ê°™ì€ í´ë”ì— íŒŒì¼ ìœ„ì¹˜
> dc.sh  
> docker-compose.yml  
> docker-compose-kafka.yml  
> docker-compose-prometheus.yml  
> docker-compose-mariadb.yml  
> application.yml

- ì»¤ë§¨ë“œ ì‹¤í–‰
```shell
./dc.sh prometheus kafka maria up -d
```

---

ë‹¤ìŒ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì ‘ì†ì‹œ keycloakì„ í†µí•œ ì¸ì¦ ì„¤ì •ë²•ì— ëŒ€í•´ ë‹¤ë£¹ë‹ˆë‹¤. 
